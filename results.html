<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Search Results</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:#ffffff;color:#000;-webkit-font-smoothing:antialiased}
  .container{max-width:1600px;margin:0 auto;padding:32px 48px;position:relative;z-index:2}
    .back{
      color:#000;
      text-decoration:none;
      margin-bottom:24px;
      display:inline-block;
      font-size:0.85rem;
      letter-spacing:0.5px;
      border-bottom:1px solid transparent;
      transition:border-color 0.2s ease;
    }
    .back:hover{border-bottom-color:#000;}

  /* layout */
  .main-layout{display:block;min-height:calc(100vh - 120px);padding-top:40px}

  /* Full-page model background */
  .model-background{position:fixed;inset:0;z-index:0;display:flex;align-items:center;justify-content:center;background:#fafafa;}
  .model-background model-viewer{width:100%;height:100%;display:block}

  /* keep an empty container for spacing if needed (no images) */
  .car-image-container{position:relative;overflow:hidden;height:120px;display:block;background:transparent}

  /* top-left header for the car title */
  .car-header{position:fixed;left:48px;top:48px;z-index:5;color:#000;pointer-events:auto}
  .car-header .car-title{font-size:1.2rem;letter-spacing:1px;font-weight:300}
  .car-header .car-subtitle{display:block;font-size:0.8rem;color:#666;letter-spacing:0.5px;margin-top:4px;font-weight:400}

  /* Bottom specs bar - horizontal layout */
  .specs-sidebar{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#ffffff;
    padding:24px 48px;
    color:#000;
    border-top:1px solid #e8e8e8;
    z-index:3;
    max-height:30vh;
    overflow:auto;
  }
    .section-title{
      color:#000;
      border-bottom:1px solid #e8e8e8;
      padding-bottom:10px;
      margin-bottom:20px;
      font-size:0.7rem;
      font-weight:400;
      letter-spacing:2px;
      text-transform:uppercase;
    }
    .specs-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:24px 32px;
    }
    .spec-item{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:0;
      border-bottom:0;
    }
    .spec-name{color:#666;font-size:0.7rem;letter-spacing:0.5px;text-transform:uppercase}
    .spec-value{color:#000;font-weight:400;font-size:0.9rem;letter-spacing:0.3px}

  /* Results list styling */
  .results-list{display:grid;gap:1px;background:#e8e8e8;border:1px solid #e8e8e8}
  .result-item{
    padding:24px 32px;
    background:#ffffff;
    display:flex;
    justify-content:space-between;
    align-items:center;
    transition:background 0.2s ease;
  }
  .result-item:hover{background:#fafafa}
  .result-item .meta{display:flex;flex-direction:column;gap:4px}
  .result-item .meta strong{font-weight:400;font-size:0.95rem;letter-spacing:0.3px}
  .result-item .meta small{font-size:0.8rem;color:#666;letter-spacing:0.3px}
  .result-item .open{
    color:#000;
    text-decoration:none;
    font-size:0.75rem;
    letter-spacing:1.5px;
    text-transform:uppercase;
    border-bottom:1px solid #000;
    padding-bottom:2px;
  }

      @media(max-width:1100px){
        .main-layout{padding-top:20px}
        .specs-sidebar{padding:24px 20px;max-height:50vh}
        .specs-grid{grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:20px 24px}
        .container{padding:24px 20px;padding-bottom:40px}
        .car-header{left:20px;top:24px}
      }
      @media(max-width:600px){
        .specs-grid{grid-template-columns:1fr 1fr;gap:16px 20px}
        .spec-name{font-size:0.65rem}
        .spec-value{font-size:0.85rem}
      }

      /* Minimal loading animation */
      .loading{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        min-height:60vh;
        gap:16px;
      }
      .loading-dots{
        display:flex;
        gap:12px;
      }
      .loading-dot{
        width:12px;
        height:12px;
        background:#000;
        border-radius:50%;
        animation:loading-pulse 1.4s ease-in-out infinite;
      }
      .loading-dot:nth-child(1){animation-delay:0s}
      .loading-dot:nth-child(2){animation-delay:0.2s}
      .loading-dot:nth-child(3){animation-delay:0.4s}
      @keyframes loading-pulse{
        0%,80%,100%{opacity:0.3;transform:scale(0.8)}
        40%{opacity:1;transform:scale(1)}
      }
      .loading-text{
        font-size:0.85rem;
        letter-spacing:2.5px;
        text-transform:uppercase;
        color:#666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a class="back" href="index.html">← Back to search</a>
      <div id="results-root">
        <div class="loading">
          <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
          </div>
          <div class="loading-text">Loading</div>
        </div>
      </div>
    </div>

    <!-- model background container (injected once) -->
    <div id="model-bg" class="model-background" aria-hidden="true" style="display:none">
      <!-- model-viewer will be injected here by JS -->
    </div>

    <script>
      // Small client-side search + renderer using backend /cars API v3
      async function loadData(){
        try{
          // Try API server first
          const res = await fetch('http://localhost:8000/cars');
          return res.ok ? res.json() : [];
        }catch(e){
          // fallback to local asset
          try{
            const res = await fetch('assets/cars.json');
            return res.ok ? res.json() : [];
          }catch(e2){
            console.error('Failed to load data:', e2);
            return [];
          }
        }
      }

      function qs(name){
        const params = new URLSearchParams(location.search);
        return params.get(name) || '';
      }

      function scoreMatch(item, q){
        q = q.toLowerCase();
        let score = 0;
        if(item.name.toLowerCase().includes(q)) score += 50;
        if(item.manufacturer.toLowerCase().includes(q)) score += 30;
        if(item.year && item.year.includes(q)) score += 20;
        if(item.slug && item.slug.includes(q)) score += 25;
        return score;
      }

      function renderList(matches){
        const root = document.getElementById('results-root');
        if(matches.length === 0){ root.innerHTML = '<div>No results found.</div>'; return; }

        // If exactly one very good match, render detail
        if(matches.length === 1 || matches[0].score > 70){ renderDetail(matches[0].item); return; }

        // Otherwise show list
        const html = [`<div class="results-list">`];
        for(const m of matches){
          html.push(`<div class="result-item" data-id="${m.item.id}"><div class="meta"><strong>${m.item.name}</strong><small>${m.item.manufacturer} · ${m.item.year}</small></div><div><a href="#" data-id="${m.item.id}" class="open">View</a></div></div>`);
        }
        html.push('</div>');
        root.innerHTML = html.join('');

        // attach view links
        root.querySelectorAll('.open').forEach(a=>{
          a.addEventListener('click', (e)=>{
            e.preventDefault();
            const id = a.getAttribute('data-id');
            const found = matches.find(m=>m.item.id===id);
            if(found) renderDetail(found.item);
          });
        });
      }

      function renderDetail(item){
        const root = document.getElementById('results-root');
        // ensure model background container exists and has a model-viewer
        const modelBg = document.getElementById('model-bg');
        if(modelBg){
          modelBg.style.display = '';
          // create model-viewer once if missing
          if(!modelBg.querySelector('model-viewer')){
            const mvEl = document.createElement('model-viewer');
            mvEl.setAttribute('id','mv-bg');
            mvEl.setAttribute('camera-controls','');
            mvEl.setAttribute('auto-rotate','');
            mvEl.setAttribute('exposure','1.0');
            mvEl.style.width = '100%';
            mvEl.style.height = '100%';
            mvEl.style.display = 'block';
            mvEl.setAttribute('environment-image','https://modelviewer.dev/shared-assets/environments/moon_1k.hdr');
            modelBg.appendChild(mvEl);
          }
        }

        // Filter specs to only show key information (exact matches only)
        const keySpecs = ['production', 'engine', 'power', 'transmission', 'weight'];
        const filteredSpecs = Object.entries(item.specs || {}).filter(([k,v]) => {
          const kLower = k.toLowerCase();
          return keySpecs.includes(kLower);
        });

        // Show specs section even if we only have some of the key specs
        const specsHTML = filteredSpecs.length > 0 ? `
          <aside class="specs-sidebar">
            <div class="section-title">Technical Specifications</div>
            <div class="specs-grid">
              ${filteredSpecs.map(([k,v])=>`<div class="spec-item"><span class="spec-name">${k}</span><span class="spec-value">${v}</span></div>`).join('')}
            </div>
          </aside>
        ` : '';

        root.innerHTML = `
          <div class="car-header"><div class="car-title">${item.name}<span class="car-subtitle">${item.year || ''}</span></div></div>
          <div class="main-layout">
            <div>
              <div class="car-image-container"></div>
            </div>
          </div>
          ${specsHTML}
        `;

        // No thumbnails to setup — images removed per request

          // Try to load a local GLB model (prefer slug, then id)
          (async function tryLoadModel(){
            const mv = document.getElementById('mv-bg');
            if(!mv) return; // no model-viewer in DOM
            const candidates = [
              `assets/models/${item.slug}.glb`,
              `assets/models/${item.id}.glb`,
              `assets/models/${item.slug}.glb`.replace('.glb','-v1.glb'),
              `assets/models/rx-7.glb`
            ];

            for(const path of candidates){
              try{
                const r = await fetch(path, {method:'HEAD'});
                if(r.ok){
                  mv.src = path;
                  mv.style.display = '';
                  return;
                }
              }catch(e){
                // fetch HEAD can fail on file://; ignore and continue
              }
            }
            // no local model found: use a safe hosted fallback and show it
            const fallbackUrl = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMilkTruck/glTF-Binary/CesiumMilkTruck.glb';
            if(mv){
              mv.src = fallbackUrl;
              mv.style.display = '';
            }
          })();
      }

      // bootstrap
      (async ()=>{
        const q = (qs('q')||'').trim();
        if(!q){ document.getElementById('results-root').textContent = 'Please enter a search query.'; return; }

        // If backend supports q, use it to fetch smaller result set
        let data = [];
        try{
          // Add timeout to prevent hanging forever
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout
          
          const res = await fetch('http://localhost:8000/cars?q=' + encodeURIComponent(q), {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          data = res.ok ? await res.json() : [];
        }catch(e){
          console.log('API fetch failed, loading local data:', e);
          if(e.name === 'AbortError'){
            document.getElementById('results-root').innerHTML = '<div style="text-align:center;padding:40px;color:#666;font-size:0.9rem;letter-spacing:0.5px;">Search is taking too long. Wikipedia may be slow or unavailable.<br><br><a href="index.html" style="color:#000;text-decoration:underline;">Try another search</a></div>';
            return;
          }
          data = await loadData();
        }

        // compute matches locally as a fallback/scoring step
        const scoredAll = data.map(item=>({item,score:scoreMatch(item,q)})).sort((a,b)=>b.score-a.score);
        // If backend returned exactly one item (e.g. a wiki fallback), show it even if score==0
        if(data.length === 1){ renderDetail(data[0]); return; }
        // Otherwise filter out zero-score items and render list
        const scored = scoredAll.filter(s=>s.score>0);
        renderList(scored);
      })();
    </script>
  </body>
</html>
